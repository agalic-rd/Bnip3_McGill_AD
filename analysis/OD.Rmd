```{r}
source(here::here("src", "setup.R"), echo = FALSE)
```

<!----------------------------------------------------------------------------->
<!----------------------------------------------------------------------------->
# I. Data:
***

```{r}
(od_data <- load_od_data())
```

<!----------------------------------------------------------------------------->
<!----------------------------------------------------------------------------->
# II. Soma:
***

<!----------------------------------------------------------------------------->
## 1. Models

```{r}
mod_soma <- glmmTMB::glmmTMB(
  od_corrected ~ genotype * age * area + (1 | rat / section),
  family = Gamma("log"),
  data = od_data$soma,
  REML = TRUE
)

cli_h1("[Parameters]")
parameters(mod_soma)
cli_h1("[Fitness]")
performance(mod_soma)
```

<!----------------------------------------------------------------------------->
## 2. Model Diagnostics

### Residual diagnostics

```{r fig.width = 10}
# Very slow
plot(check_model(mod_soma, check = c("qq", "normality", "linearity", "reqq", "pp_check", "vif"))) # -> mod_soma_diag

# ggsave(plot = mod_od_diag, filename = "mod_soma_diag.png", width = 16, height = 9)
```

### Predictive checks

```{r}
mod_soma_dharma <- DHARMa::simulateResiduals(mod_soma, plot = FALSE, n = 300, seed = getOption("seed"))
mod_soma_dharma_t <- t(mod_soma_dharma$simulatedResponse)
```

```{r}
# png("mod_soma_dharma_residuals.png", width = 16, height = 9, units = "in", res = 600)
plot(mod_soma_dharma, asFactor = TRUE)
# dev.off()
```

```{r fig.width = 10}
ppc_plots(mod_soma, simulations = mod_soma_dharma_t, term = "genotype")
ppc_plots(mod_soma, simulations = mod_soma_dharma_t, term = "age")
ppc_plots(mod_soma, simulations = mod_soma_dharma_t, term = "area")
```

```{r fig.width = 10}
ppc_stat_plots(mod_soma, simulations = mod_soma_dharma_t, term = "genotype")
ppc_stat_plots(mod_soma, simulations = mod_soma_dharma_t, term = "age")
ppc_stat_plots(mod_soma, simulations = mod_soma_dharma_t, term = "area")
```

### Potential outliers

```{r}
get_model_based_outliers(od_data$soma, mod_soma, mod_soma_dharma, "od_corrected")
```

<!----------------------------------------------------------------------------->
## 3. Model Analysis

```{r}
p_adjust <- "holm"
```

### Model parameters

**All effects (Wald):**

```{r}
parameters(
  mod_soma, exponentiate = should_exp(mod_soma),
  ci_method = "Wald", p_adjust = p_adjust, summary = TRUE, digits = 3
)
```

**Main effects (Wald):**

```{r}
car::Anova(mod_soma, type = 3)
```

### Marginal means

**Genotype**

```{r}
cli_h1("[Observed]")

distribution_summary(get_data(mod_soma), dvs = find_response(mod_soma), between = "genotype")

cli_h1("[Emmeans]")

emmeans(mod_soma, specs = "genotype", regrid = "response")
```

**Age**

```{r}
cli_h1("[Observed]")

distribution_summary(get_data(mod_soma), dvs = find_response(mod_soma), between = "age")

cli_h1("[Emmeans]")

emmeans(mod_soma, specs = "age", regrid = "response")
```

**Genotype:Age**

```{r}
cli_h1("[Observed]")

distribution_summary(get_data(mod_soma), dvs = find_response(mod_soma), between = c("genotype", "age"))

cli_h1("[Emmeans]")

emmeans(mod_soma, specs = ~ genotype | age, regrid = "response")
```

### Contrasts

**Genotype**

```{r}
emmeans(mod_soma, specs = "genotype", type = "response") |> 
  contrast(method = "pairwise", adjust = p_adjust, infer = TRUE)
```

```{r fig.width = 4, fig.height = 7}
make_signif_boxplot(mod_soma, xaxis = "genotype") |> 
  save_png("mod_soma_genotype", width = 4, height = 7)
```

**Age**

```{r}
emmeans(mod_soma, specs = "age", type = "response") |> 
  contrast(method = "pairwise", adjust = p_adjust, infer = TRUE)
```

```{r fig.width = 4, fig.height = 7}
make_signif_boxplot(mod_soma, xaxis = "age", adjust = p_adjust)
```

**Genotype:Age**

Genotype within Age:

```{r}
emmeans(mod_soma, specs = ~ genotype | age, type = "response") |>
  contrast(method = "pairwise", adjust = "none", infer = TRUE) |>
  as.data.frame() |>
  modify_at("p.value", \(x) p.adjust(x, method = p_adjust))
```

```{r fig.width = 14, fig.height = 6}
make_signif_boxplot(mod_soma, xaxis = "genotype", facet = "age", ncol = 4, max_points = Inf, adjust = p_adjust) |>
  save_png("mod_soma_genotype_age", width = 14, height = 7, display = TRUE)
```

Age within Genotype:

```{r}
emmeans(mod_soma, specs = ~ age | genotype, type = "response") |>
  contrast(method = "pairwise", adjust = "none", infer = TRUE) |>
  as.data.frame() |>
  modify_at("p.value", \(x) p.adjust(x, method = p_adjust))
```

```{r fig.width = 14, fig.height = 6}
make_signif_boxplot(mod_soma, xaxis = "age", facet = "genotype", ncol = 4, max_points = Inf, adjust = p_adjust) |> 
  save_png("mod_soma_age_genotype", width = 14, height = 7, display = TRUE)
```

Difference in Genotype's effect between Ages:

```{r}
emmeans(mod_soma, specs = ~ genotype | age, type = "response") |>
  contrast(interaction = "pairwise", by = NULL, adjust = "none", infer = TRUE) |> 
  as.data.frame() |> 
  modify_at("p.value", \(x) p.adjust(x, method = p_adjust))
```

```{r fig.height = 6, fig.width = 14}
make_signif_boxplot_inter(
  mod_soma, pred1 = "genotype", pred2 = "age", facet = NULL, 
  cluster = "rat", add_cluster_averages = TRUE, ncol = 5, max_points = Inf, adjust = p_adjust
) |> 
  save_png("mod_soma_genotype_age_inter", width = 14, height = 7)
```

**Genotype:Area**

Genotype within Area:

```{r}
emmeans(mod_soma, specs = ~ genotype | area, type = "response") |>
  contrast(method = "pairwise", adjust = "none", infer = TRUE) |>
  as.data.frame() |>
  modify_at("p.value", \(x) p.adjust(x, method = p_adjust))
```

```{r fig.width = 14, fig.height = 6}
make_signif_boxplot(mod_soma, xaxis = "genotype", facet = "area", ncol = 4, max_points = Inf, adjust = p_adjust) |>
  save_png("mod_soma_genotype_area", width = 14, height = 7, display = TRUE)
```

Area within Genotype:

```{r}
emmeans(mod_soma, specs = ~ area | genotype, type = "response") |>
  contrast(method = "pairwise", adjust = "none", infer = TRUE) |>
  as.data.frame() |>
  modify_at("p.value", \(x) p.adjust(x, method = p_adjust))
```

```{r fig.width = 14, fig.height = 6}
make_signif_boxplot(mod_soma, xaxis = "area", facet = "genotype", ncol = 4, max_points = Inf, adjust = p_adjust) |>
  save_png("mod_soma_area_genotype", width = 14, height = 7, display = TRUE)
```

Difference in Genotype's effect between Areas:

```{r}
emmeans(mod_soma, specs = ~ genotype | area, type = "response") |>
  contrast(interaction = "pairwise", by = NULL, adjust = "none", infer = TRUE) |> 
  as.data.frame() |> 
  modify_at("p.value", \(x) p.adjust(x, method = p_adjust))
```

```{r fig.height = 6, fig.width = 14}
make_signif_boxplot_inter(
  mod_soma, pred1 = "genotype", pred2 = "area", facet = NULL, 
  cluster = "rat", add_cluster_averages = TRUE, ncol = 5, max_points = Inf, adjust = p_adjust
) |> 
  save_png("mod_soma_genotype_area_inter", width = 14, height = 7)
```

**Genotype:Age:Area**

Difference in Genotype's effect between Areas within Ages:

```{r}
emmeans(mod_soma, specs = ~ genotype * area | age, type = "response") |>
  contrast(interaction = "pairwise", by = "age", adjust = "none", infer = TRUE) |> 
  as.data.frame() |> 
  modify_at("p.value", \(x) p.adjust(x, method = p_adjust))
```

```{r fig.height = 6, fig.width = 14}
make_signif_boxplot_inter(
  mod_soma, pred1 = "genotype", pred2 = "area", facet = "age", 
  cluster = "rat", add_cluster_averages = TRUE, ncol = 5, max_points = Inf, adjust = p_adjust
) |> 
  save_png("mod_soma_genotype_area_inter_age", width = 14, height = 7)
```

Difference in Age's effect between Areas within Genotype:

```{r}
emmeans(mod_soma, specs = ~ age * area | genotype, type = "response") |>
  contrast(interaction = "pairwise", by = "genotype", adjust = "none", infer = TRUE) |> 
  as.data.frame() |> 
  modify_at("p.value", \(x) p.adjust(x, method = p_adjust))
```

```{r fig.height = 6, fig.width = 14}
make_signif_boxplot_inter(
  mod_soma, pred1 = "age", pred2 = "area", facet = "genotype", 
  cluster = "rat", add_cluster_averages = TRUE, ncol = 5, max_points = Inf, adjust = p_adjust
) |> 
  save_png("mod_soma_age_area_inter_genotype", width = 14, height = 7)
```


<!----------------------------------------------------------------------------->
<!----------------------------------------------------------------------------->
# III. Soma-Pooled:
***

<!----------------------------------------------------------------------------->
## 1. Models

```{r}
mod_soma_pooled <- glmmTMB::glmmTMB(
  od_corrected ~ genotype + (1 | rat / section),
  family = Gamma("log"),
  data = od_data$soma,
  REML = TRUE
)

cli_h1("[Parameters]")
parameters(mod_soma_pooled)
cli_h1("[Fitness]")
performance(mod_soma_pooled)
```

<!----------------------------------------------------------------------------->
## 2. Model Diagnostics

### Residual diagnostics

```{r fig.width = 10}
# Slow
check_model(mod_soma_pooled, check = c("qq", "normality", "linearity", "ncv", "reqq", "pp_check", "vif"))
```

### Predictive checks

```{r}
mod_soma_pooled_dharma <- DHARMa::simulateResiduals(mod_soma_pooled, plot = FALSE, n = 300, seed = getOption("seed"))
mod_soma_pooled_dharma_t <- t(mod_soma_pooled_dharma$simulatedResponse)
```

```{r}
plot(mod_soma_pooled_dharma)
```

```{r fig.width = 10}
ppc_plots(mod_soma_pooled, simulations = mod_soma_pooled_dharma_t, term = "genotype")
```

```{r fig.width = 10}
ppc_stat_plots(mod_soma_pooled, simulations = mod_soma_pooled_dharma_t, term = "genotype")
```

### Potential outliers

```{r}
get_model_based_outliers(od_data$soma, mod_soma_pooled, mod_soma_pooled_dharma, "od_corrected")
```

<!----------------------------------------------------------------------------->
## 3. Model Analysis

### Model parameters

**All effects (Wald):**

```{r}
parameters(
  mod_soma_pooled, exponentiate = should_exp(mod_soma_pooled),
  ci_method = "Wald", p_adjust = "none", summary = TRUE, digits = 3
)
```

**Main effects (Wald):**

```{r}
car::Anova(mod_soma_pooled, type = 3)
```

### Marginal means

```{r}
cli_h1("[Observed]")

distribution_summary(get_data(mod_soma_pooled), dvs = find_response(mod_soma_pooled), between = "genotype")

cli_h1("[Emmeans]")

emmeans(mod_soma_pooled, specs = "genotype", regrid = "response")
```

### Contrasts

```{r}
emmeans(mod_soma_pooled, specs = "genotype", type = "response") |> 
  contrast(method = "pairwise", adjust = "none", infer = TRUE)
```

```{r fig.width = 6, fig.height = 7}
make_signif_boxplot(mod_soma_pooled, xaxis = "genotype", max_points = Inf) |> 
  save_png("mod_soma_pooled_genotype", width = 6, height = 7, display = TRUE)
```


<!----------------------------------------------------------------------------->
<!----------------------------------------------------------------------------->
# IV. Molecular Layer:
***

<!----------------------------------------------------------------------------->
## 1. Models

```{r}
mod_ml <- glmmTMB(
  od_corrected ~ genotype * age + (1 | rat),
  family = Gamma("log"),
  data = od_data$ml,
  REML = TRUE
)

cli_h1("[Parameters]")
parameters(mod_ml)
cli_h1("[Fitness]")
performance(mod_ml)
```

<!----------------------------------------------------------------------------->
## 2. Model Diagnostics

### Residual diagnostics

```{r fig.width = 10}
plot(check_model(mod_ml, check = c("qq", "normality", "linearity", "reqq", "pp_check", "vif"))) # -> mod_ml_diag

# ggsave("mod_ml_diag.png", mod_ml_diag, width = 16, height = 9)

make_acf_plot(mod_ml)
```

### Predictive checks

```{r}
mod_ml_dharma <- DHARMa::simulateResiduals(mod_ml, plot = FALSE, n = 300, seed = getOption("seed"))
mod_ml_dharma_t <- t(mod_ml_dharma$simulatedResponse)
```

```{r fig.width = 10}
# png("mod_ml_dharma_residuals.png", width = 16, height = 9, units = "in", res = 600)
plot(mod_ml_dharma)
# dev.off()
```

```{r fig.width = 10}
ppc_plots(mod_ml, simulations = mod_ml_dharma_t, term = "genotype")
ppc_plots(mod_ml, simulations = mod_ml_dharma_t, term = "age")
```

```{r fig.width = 10}
ppc_stat_plots(mod_ml, simulations = mod_ml_dharma_t, term = "genotype")
ppc_stat_plots(mod_ml, simulations = mod_ml_dharma_t, term = "age")
```

### Potential outliers

```{r}
get_model_based_outliers(od_data$ml, mod_ml, mod_ml_dharma, "od_corrected")
```

<!----------------------------------------------------------------------------->
## 3. Model Analysis

```{r}
p_adjust <- "holm"
```

### Model parameters

**All effects (Wald):**

```{r}
parameters(
  mod_ml, exponentiate = should_exp(mod_ml),
  ci_method = "Wald", p_adjust = p_adjust, summary = TRUE, digits = 3
)
```

**Main effects (Wald):**

```{r}
car::Anova(mod_ml, type = 3)
```

### Marginal means

**Genotype**

```{r}
cli_h1("[Observed]")

distribution_summary(get_data(mod_ml), dvs = find_response(mod_ml), between = "genotype")

cli_h1("[Emmeans]")

emmeans(mod_ml, specs = "genotype", regrid = "response")
```

**Age**

```{r}
cli_h1("[Observed]")

distribution_summary(get_data(mod_ml), dvs = find_response(mod_ml), between = "age")

cli_h1("[Emmeans]")

emmeans(mod_ml, specs = "age", regrid = "response")
```

**Genotype:Age**

```{r}
cli_h1("[Observed]")

distribution_summary(get_data(mod_ml), dvs = find_response(mod_ml), between = c("genotype", "age"))

cli_h1("[Emmeans]")

emmeans(mod_ml, specs = ~ genotype | age, regrid = "response")
```

### Contrasts

**Genotype**

```{r}
emmeans(mod_ml, specs = "genotype", type = "response") |> 
  contrast(method = "pairwise", adjust = p_adjust, infer = TRUE)
```

```{r fig.width = 4, fig.height = 7}
make_signif_boxplot(mod_ml, xaxis = "genotype") |> 
  save_png("mod_ml_genotype", width = 4, height = 7, display = TRUE)
```

**Age**

```{r}
emmeans(mod_ml, specs = "age", type = "response") |> 
  contrast(method = "pairwise", adjust = p_adjust, infer = TRUE)
```

```{r fig.width = 4, fig.height = 5}
make_signif_boxplot(mod_ml, xaxis = "age", adjust = p_adjust)
```

**Genotype:Age**

Genotype within Age:

```{r}
emmeans(mod_ml, specs = ~ genotype | age, type = "response") |> 
  contrast(method = "pairwise", adjust = "none", infer = TRUE) |> 
  as.data.frame() |> 
  modify_at("p.value", \(x) p.adjust(x, method = p_adjust))
```

```{r fig.width = 14, fig.height = 6}
make_signif_boxplot(mod_ml, xaxis = "genotype", facet = "age", ncol = 4, max_points = Inf, adjust = p_adjust) |>
  save_png("mod_ml_genotype_age", width = 14, height = 7, display = TRUE)
```

Age within Genotype:

```{r}
emmeans(mod_ml, specs = ~ age | genotype, type = "response") |> 
  contrast(method = "pairwise", adjust = "none", infer = TRUE) |> 
  as.data.frame() |> 
  modify_at("p.value", \(x) p.adjust(x, method = p_adjust))
```

```{r fig.width = 14, fig.height = 6}
make_signif_boxplot(mod_ml, xaxis = "age", facet = "genotype", ncol = 4, max_points = Inf, adjust = p_adjust) |>
  save_png("mod_ml_age_genotype", width = 14, height = 7, display = TRUE)
```

Difference in Genotype's effect between Ages:

```{r}
emmeans(mod_ml, specs = ~ genotype | age, type = "response") |>
  contrast(interaction = "pairwise", by = NULL, adjust = "none", infer = TRUE) |> 
  as.data.frame() |> 
  modify_at("p.value", \(x) p.adjust(x, method = p_adjust))
```

```{r fig.height = 6, fig.width = 14}
make_signif_boxplot_inter(
  mod_ml, pred1 = "genotype", pred2 = "age", facet = NULL, 
  cluster = "rat", add_cluster_averages = TRUE, ncol = 5, max_points = Inf, adjust = p_adjust
) |> 
  save_png("mod_ml_genotype_age_inter", width = 14, height = 7)
```
